# Request Id Filter

[![Build Status](https://travis-ci.org/imamchishty/filter-request-id.svg?branch=master "filter-request-id")](https://travis-ci.org/imamchishty/filter-request-id) [![Maven Central](https://maven-badges.herokuapp.com/maven-central/com.shedhack.filter/filter-request-id/badge.svg?style=plastic)](https://maven-badges.herokuapp.com/maven-central/com.shedhack.filter/filter-request-id)

## Introduction
In distributed systems it is difficult to trace the execution paths of multiple services.
This filter will set several header properties, MDC for logging and will also provide an easy to access ThreadLocal utility class.

The three properties are:

- __request-id__: the servlet filter attempts to create a 'request-id' header property 
if this hasn't already been set. The request-id is unique for the given request and can be used
for many purposes such as building metrics (user request count), auditing,
logging, exception handling etc. The Id is create by the Java `UUID` class, which guarantees an
incredibly low chance of a collision (thus the Id can be used to search for particular requests).

- __group-id__: in the world of soa and micro-services, services are not isolated. Services almost
always call other distributed services. Let's take an example, a user submits a request on his
iphone app. The app calls a backend service which itself calls multiple services. In order to see
which services were called you could use a 'group-id'. The group Id is a unique parent/wrapper Id.
Searching for just this in your centralised logs would show all service calls. This is not to be
confused with the request Id which is the Id for a single service call.

- __'caller-id'__: as mentioned above services interact with other services. One service is the client
whilst the other is provider (server). The interaction between the two services can logged
using the use of a 'caller-id'. When service A calls service B, the caller-id that I'm
alluding to is the request-id that A originally had set in its header. The HTTP request
will therefore contain the caller-id and the group-id. The request-id would be generated by this
filter or by a web server.
 
To enable easy access to the request Id value it gets stored on as a ThreadLocal variable.
Please note that the MDC and the ThreadLocal get cleaned up in this filter.

If you're using Spring then [thread-context-aspect](https://github.com/imamchishty/thread-context-aspect) and [thread-context-handler](https://github.com/imamchishty/thread-context-handler) would be able to use the properties and add more contextual details to the thread context. Please refer to those projects for more details.

## Filter Request API

Implementations of the API can be provided when constructing the filters. Please refer to [filter-request-api](https://github.com/imamchishty/filter-request-api) for details.

## Thread Local

The request model is also stored as a Thread Local variable. A static library, 
[Thread Local Utility](https://github.com/imamchishty/filter-request-api/blob/master/src/main/java/com/shedhack/filter/api/threadlocal/RequestThreadLocalHelper.java) has been used to manage it (set/get/remove). 
The object stored in the TL is a [__RequestModel__](https://github.com/imamchishty/filter-request-api/blob/master/src/main/java/com/shedhack/filter/api/model/DefaultRequestModel.java).
You can use this library to get access to the variable. The filter will also clear the TL. 

## MDC

Using slf4j's MDC the following properties are 

- __request-id__
- __group-id__
- __caller-id__

These are set via the `setup(RequestModel model)` method. You could override this whilst extending RequestTraceFilter. 

The MDC is cleared by the filter.

## Logging

The filter logs the request (upon completion). The log entry will look something like:

`2016-04-16 17:10:15.167  INFO 18343 --- [{}, context={}}] c.s.t.r.filter.DefaultLoggingHandler     : {"requestId": "5f3e26f0-6fa2-4174-9665-ceb1f6193900", "applicationId": "hello-world", "groupId": "63f55640-73ae-495e-975a-62470832dfa9", "callerId": "null", "path": "/problem", "sessionId": "093B287BCEFDF582D2E5C8A4B16B90F7", "httpMethod": "GET", "clientAddress": "0:0:0:0:0:0:0:1", "hostAddress": "localhost:8080", "headers": "{"host":"localhost:8080","connection":"close","user-agent":"HTTP%20Client/1.0.3 CFNetwork/720.5.7 Darwin/14.5.0 (x86_64)"}", "exceptionId": "aefdab47-9188-4c36-8fa6-b59e806c219c", "requestDateTime": "Sat Apr 16 17:10:14 GST 2016", "responseDateTime": "Sat Apr 16 17:10:15 GST 2016", "status": "FAILED"}`


### web.xml

Within the `<web-app>` element you add the following:

	<filter> 
    		<filter-name>requestTraceFilter</filter-name>
    		<filter-class>com.shedhack.filter.requestid.filter.RequestTraceFilter</filter-class> 
  	</filter> 
  	<filter-mapping> 
    		<filter-name>requestTraceFilter</filter-name>
    		<url-pattern>/*</url-pattern> 
  	</filter-mapping> 

### Spring

    @Bean
    public FilterRegistrationBean filterRegistrationBean() {
        FilterRegistrationBean filter = new FilterRegistrationBean();
        filter.setFilter(new RequestTraceFilter());
        return filter;
    }

## Dependencies

The servlet-api is used, the actual implementation is your projects choice.

    <!-- Only using the API, clients will need to provide concrete implementations of their choice -->
    <dependency>
        <groupId>javax.servlet</groupId>
        <artifactId>javax.servlet-api</artifactId>
        <version>3.1.0</version>
    </dependency>
    
API library:
    
    <dependency>
        <groupId>com.shedhack.filter</groupId>
        <artifactId>filter-request-api</artifactId>
        <version>1.0.0</version>
    </dependency>

        
## Java requirements

Project has been built using JDK 1.8.

## Maven central

This artifact is available in [Maven Central](https://maven-badges.herokuapp.com/maven-central/com.shedhack.filter/filter-request-id).
 
    <dependency>
        <groupId>com.shedhack.filter</groupId>
        <artifactId>filter-request-id</artifactId>
        <version>x.x.x</version>
    </dependency>    


Contact
-------

	Please feel free to contact me via email, imamchishty@gmail.com
